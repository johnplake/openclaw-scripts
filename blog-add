#!/bin/bash
# blog-add - Add or update content in the Quarto blog
#
# USAGE:
#   blog-add <TYPE> --title "..." --author "..." --date "YYYY-MM-DD" \
#            --url "..." --categories "topic1,topic2" \
#            [--date-added "YYYY-MM-DD"] [--summary "..."] \
#            [--status STATUS] [--commit] [--publish]
#
#   blog-add <TYPE> --update slug-name [--summary "..."] [--status STATUS] \
#            [--categories "..."] [--commit] [--publish]
#
# TYPES:
#   readings   - Articles, blog posts, essays
#   video      - YouTube videos, talks, lectures
#   book       - Books (print or digital)
#   paper      - Academic papers
#   listening  - Podcasts, audiobooks, audio content
#
# WHAT TO LOOK UP BEFORE RUNNING (CREATE MODE):
#   1. Content title (exact, for front matter)
#   2. Author/creator name
#   3. Publication/release date (original date, format: YYYY-MM-DD)
#   4. URL (canonical/original link)
#   5. Relevant categories/tags (AI, philosophy, research, etc.)
#   6. Brief summary or excerpt (optional, can add later via --update)
#
# STATUS VALUES BY TYPE:
#   readings:  to-read (default) | finished
#   video:     to-watch (default) | finished
#   book:      to-read (default) | finished
#   paper:     to-read (default) | finished
#   listening: to-listen (default) | finished
#
# FLAGS:
#   --date-added YYYY-MM-DD  Date added to collection (defaults to today)
#   --update SLUG            Update existing entry instead of creating new
#   --commit                 Auto-commit the changes
#   --publish                Auto-publish to gh-pages (implies --commit)
#
# EXAMPLES (CREATE):
#   blog-add readings --title "The Bitter Lesson" --author "Rich Sutton" \
#            --date "2019-03-13" --url "http://incompleteideas.net/..." \
#            --categories "AI,machine-learning" --commit --publish
#
#   blog-add video --title "Attention Is All You Need" --author "Ashish Vaswani" \
#            --date "2017-12-06" --url "https://youtube.com/watch?v=..." \
#            --categories "AI,transformers" --summary "NeurIPS 2017 talk" --commit
#
#   blog-add book --title "Aesthetic Measure" --author "George Birkhoff" \
#            --date "1933" --url "https://archive.org/details/..." \
#            --categories "aesthetics,mathematics" --commit --publish
#
#   blog-add listening --title "How to Change a Memory" --author "Steve Ramirez" \
#            --date "2026-02-19" --url "https://wbur.org/onpoint/..." \
#            --categories "neuroscience,memory" --commit --publish
#
# EXAMPLES (UPDATE):
#   blog-add readings --update the-bitter-lesson --status finished --commit --publish
#   blog-add video --update attention-is-all-you-need \
#            --summary "Detailed explanation of transformer architecture" --commit

set -euo pipefail

BLOG_DIR="$HOME/.openclaw/workspace/blog/quarto-blog"

# Validate type argument
if [[ $# -lt 1 ]]; then
  echo "ERROR: Missing content type"
  echo "Usage: blog-add <TYPE> [options]"
  echo "Types: readings, video, book, paper, listening"
  exit 1
fi

TYPE="$1"
shift

# Validate and normalize type
case "$TYPE" in
  readings|reading)
    TYPE="readings"
    TYPE_DIR="readings"
    DEFAULT_STATUS="to-read"
    ;;
  video|videos)
    TYPE="video"
    TYPE_DIR="videos"
    DEFAULT_STATUS="to-watch"
    ;;
  book|books)
    TYPE="book"
    TYPE_DIR="books"
    DEFAULT_STATUS="to-read"
    ;;
  paper|papers)
    TYPE="paper"
    TYPE_DIR="papers"
    DEFAULT_STATUS="to-read"
    ;;
  listening)
    TYPE="listening"
    TYPE_DIR="listening"
    DEFAULT_STATUS="to-listen"
    ;;
  *)
    echo "ERROR: Invalid type '$TYPE'"
    echo "Valid types: readings, video, book, paper, listening"
    exit 1
    ;;
esac

CONTENT_DIR="$BLOG_DIR/$TYPE_DIR"

# Default values
STATUS=""
SUMMARY=""
DO_COMMIT=false
DO_PUBLISH=false
UPDATE_SLUG=""
TITLE=""
AUTHOR=""
DATE=""
DATE_ADDED=""
URL=""
CATEGORIES=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --update)
      UPDATE_SLUG="$2"
      shift 2
      ;;
    --title)
      TITLE="$2"
      shift 2
      ;;
    --author)
      AUTHOR="$2"
      shift 2
      ;;
    --date)
      DATE="$2"
      shift 2
      ;;
    --date-added)
      DATE_ADDED="$2"
      shift 2
      ;;
    --url)
      URL="$2"
      shift 2
      ;;
    --categories)
      CATEGORIES="$2"
      shift 2
      ;;
    --status)
      STATUS="$2"
      shift 2
      ;;
    --summary)
      SUMMARY="$2"
      shift 2
      ;;
    --commit)
      DO_COMMIT=true
      shift
      ;;
    --publish)
      DO_PUBLISH=true
      DO_COMMIT=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# UPDATE MODE
if [[ -n "$UPDATE_SLUG" ]]; then
  ENTRY_DIR="$CONTENT_DIR/$UPDATE_SLUG"
  INDEX_FILE="$ENTRY_DIR/index.qmd"
  
  if [[ ! -f "$INDEX_FILE" ]]; then
    echo "ERROR: Entry not found: $INDEX_FILE"
    exit 1
  fi
  
  echo "ðŸ“ Updating $TYPE: $UPDATE_SLUG"
  
  # Read existing file
  FRONTMATTER=$(awk '/^---$/,/^---$/ {print}' "$INDEX_FILE")
  BODY=$(awk '/^---$/,/^---$/ {next} {body=body"\n"$0} END {print body}' "$INDEX_FILE")
  
  # Update summary if provided
  if [[ -n "$SUMMARY" ]]; then
    # Extract everything after second --- and before [Read/Watch/Listen link
    BODY="$SUMMARY\n\n$(echo "$BODY" | grep -E -A 1000 '\[(Read|Watch|Listen)')"
    echo "   âœ“ Updated summary"
  fi
  
  # Update status if provided
  if [[ -n "$STATUS" ]]; then
    FRONTMATTER=$(echo "$FRONTMATTER" | sed "s/^status: .*/status: $STATUS/")
    echo "   âœ“ Updated status to: $STATUS"
  fi
  
  # Update categories if provided
  if [[ -n "$CATEGORIES" ]]; then
    CATEGORIES_YAML=$(echo "$CATEGORIES" | sed 's/,/, /g')
    FRONTMATTER=$(echo "$FRONTMATTER" | sed "s/^categories: .*/categories: [$CATEGORIES_YAML]/")
    echo "   âœ“ Updated categories"
  fi
  
  # Write back to file
  echo "$FRONTMATTER" > "$INDEX_FILE"
  echo "$BODY" >> "$INDEX_FILE"
  
  echo "âœ… Updated: $INDEX_FILE"
  
  # Commit if requested
  if [[ "$DO_COMMIT" == true ]]; then
    cd "$BLOG_DIR"
    git add "$ENTRY_DIR"
    git commit -m "Update $TYPE: $UPDATE_SLUG"
    git push
    echo "âœ… Committed and pushed to master"
  fi
  
  # Publish if requested
  if [[ "$DO_PUBLISH" == true ]]; then
    cd "$BLOG_DIR"
    ~/.openclaw/workspace/bin/quarto publish gh-pages --no-prompt
    echo "âœ… Published to GitHub Pages"
  fi
  
  exit 0
fi

# CREATE MODE - Validate required fields
if [[ -z "$TITLE" || -z "$AUTHOR" || -z "$URL" ]]; then
  echo "ERROR: Missing required fields for create mode"
  echo "Required: --title, --author, --url"
  echo "Optional but recommended: --date (publication date)"
  exit 1
fi

# Set default status if not provided
if [[ -z "$STATUS" ]]; then
  STATUS="$DEFAULT_STATUS"
fi

# Set default date-added if not provided
if [[ -z "$DATE_ADDED" ]]; then
  DATE_ADDED=$(date +%Y-%m-%d)
fi

# Generate slug from title (lowercase, replace spaces/special chars with dashes)
SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

# Create directory
ENTRY_DIR="$CONTENT_DIR/$SLUG"
if [[ -d "$ENTRY_DIR" ]]; then
  echo "ERROR: Entry directory already exists: $ENTRY_DIR"
  echo "Use: blog-add $TYPE --update $SLUG ..."
  exit 1
fi

mkdir -p "$ENTRY_DIR"

# Parse categories into YAML list format
CATEGORIES_YAML=$(echo "$CATEGORIES" | sed 's/,/, /g')

# Determine link text based on type
case "$TYPE" in
  readings)
    LINK_TEXT="Read the full article"
    ;;
  video)
    LINK_TEXT="Watch"
    ;;
  book)
    LINK_TEXT="View book"
    ;;
  paper)
    LINK_TEXT="Paper link"
    ;;
  listening)
    LINK_TEXT="Listen"
    ;;
esac

# Generate index.qmd
cat > "$ENTRY_DIR/index.qmd" << EOF
---
title: "$TITLE"
author: "$AUTHOR"
EOF

# Add date field if provided
if [[ -n "$DATE" ]]; then
  echo "date: \"$DATE\"" >> "$ENTRY_DIR/index.qmd"
fi

# Add date-added and remaining fields
cat >> "$ENTRY_DIR/index.qmd" << EOF
date-added: "$DATE_ADDED"
categories: [$CATEGORIES_YAML]
status: $STATUS
url: "$URL"
---

${SUMMARY:-Brief description...}

[$LINK_TEXT â†’]($URL)
EOF

echo "âœ… Created $TYPE: $ENTRY_DIR/index.qmd"
echo "   Title: $TITLE"
echo "   Author: $AUTHOR"
echo "   Slug: $SLUG"
echo "   Status: $STATUS"
echo "   Date added: $DATE_ADDED"

# Commit if requested
if [[ "$DO_COMMIT" == true ]]; then
  cd "$BLOG_DIR"
  git add "$ENTRY_DIR"
  git commit -m "Add $TYPE: $TITLE"
  git push
  echo "âœ… Committed and pushed to master"
fi

# Publish if requested
if [[ "$DO_PUBLISH" == true ]]; then
  cd "$BLOG_DIR"
  ~/.openclaw/workspace/bin/quarto publish gh-pages --no-prompt
  echo "âœ… Published to GitHub Pages"
fi
